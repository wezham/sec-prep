# Rootkit

A rootkit gives us a means of interacting with a system after with manage to exploit it. 
For example, we may wish to establish command and control after some piece of 
malware has been installed on the machine.

The formal definition:

> ... a rootkit is a set of code that allows someone to control
certain aspects of the host operating system without revealing his or her
presence. Fundamentally, that’s what makes a rootkit—evasion of end user
knowledge

## Kernel Loadable Modules

KLM are a means for sys admins to extend the kernel. There are a number of 
use cases for this. 

1. Syscall Module - A KLM to install a new syscall 
1. Character device,Module - A KLM to install a new character device like reading from /dev/null

# Syscall Hooking 

Involves modifying the control flow of a syscall to modify the behaviour. Often
whilst preserving the original behaviour.

Take for example:

```
open -> modified_open -> original_open
``` 

We do this by modifying the sysent array to overwrite the syscall function that
gets called for our target syscall. 

Suppose a particular program is our target, how do we know which syscall to hook?

__Kernel Process Tracing__

|System Call | Purpose of Hook|
| ---- | ---- |
|read, readv, pread, preadv |Logging input|
|write, writev, pwrite, pwritev |Logging output|
|open |Hiding file contents|
|unlink |Preventing file removal|
|chdir |Preventing directory traversal|
|chmod |Preventing file mode modification|
|chown |Preventing ownership change|
|kill |Preventing signal sending|
|ioctl |Manipulating |
|execve |Redirecting file execution|
|rename |Preventing file renaming|
|rmdir |Preventing directory removal|
|stat, lstat |Hiding file status|
|getdirentries |Hiding files|
|truncate |Preventing file truncating or extending|
|kldload |Preventing module loading|
|kldunload |Preventing module unloading|


## DKOM - Direct Kernel Object Manipulation

### Hiding a running process 

The kernel holds in memory a number of data structures to represent a running 
process. In order to hide a running process we can use a number of methods 
to remove a process from the list of reported processes. 

When doing this we need to take into account some important attributes like 
syncronisation. As if we corrupt these data structures we risk corrupting the 
machine we are targetting.

* `allprocs` list
* `pidhash`

Rather than mocking out all of the places that might be able to find a process.
A good method for discovering where you need to remove - `look for the process
cleanup code that gets called when a process is terminated!`

### Hiding an open TCP connection